name: Build and Release Android App

on:
  push:
    branches:
      - master
    tags:
      - 'v*.*.*'
  workflow_dispatch:

permissions:
  contents: write
  actions: read
  packages: write
  pull-requests: write

jobs:
  build:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && !startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      - name: Configure repositories for GitHub Actions
        run: |
          mkdir -p ~/.gradle
          cat > ~/.gradle/init.gradle << 'EOF'
          allprojects {
              repositories.clear()
              repositories {
                  google()
                  mavenCentral()
                  gradlePluginPortal()
                  maven { url "https://jitpack.io" }
              }
          }
          settingsEvaluated { settings ->
              settings.pluginManagement {
                  repositories {
                      gradlePluginPortal()
                      google()
                      mavenCentral()
                  }
              }
          }
          EOF
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      - name: Clean project
        run: ./gradlew clean --no-daemon
      - name: Build (Check only)
        run: ./gradlew compileDebugKotlin --no-daemon

  release:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      - name: Configure repositories for GitHub Actions
        run: |
          mkdir -p ~/.gradle
          cat > ~/.gradle/init.gradle << 'EOF'
          allprojects {
              repositories.clear()
              repositories {
                  google()
                  mavenCentral()
                  gradlePluginPortal()
                  maven { url "https://jitpack.io" }
              }
          }
          settingsEvaluated { settings ->
              settings.pluginManagement {
                  repositories {
                      gradlePluginPortal()
                      google()
                      mavenCentral()
                  }
              }
          }
          EOF
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      - name: Clean project
        run: ./gradlew clean --no-daemon
      - name: Build Debug APK
        run: ./gradlew assembleDebug --no-daemon
      - name: Build Release APK (unsigned)
        run: ./gradlew assembleRelease --no-daemon
      - name: Get version name
        id: version
        run: |
          VERSION_NAME=$(./gradlew -q printVersionName | tail -n 1)
          echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "Version: $VERSION_NAME"
      - name: Rename APK files
        run: |
          mv app/build/outputs/apk/debug/app-debug.apk app/build/outputs/apk/debug/SMSforwarder-${{ steps.version.outputs.version_name }}-debug.apk
          mv app/build/outputs/apk/release/app-release-unsigned.apk app/build/outputs/apk/release/SMSforwarder-${{ steps.version.outputs.version_name }}-release-unsigned.apk
      - name: Generate checksums
        run: |
          cd app/build/outputs/apk
          sha256sum debug/SMSforwarder-${{ steps.version.outputs.version_name }}-debug.apk > debug/SMSforwarder-${{ steps.version.outputs.version_name }}-debug-checksums.txt
          sha256sum release/SMSforwarder-${{ steps.version.outputs.version_name }}-release-unsigned.apk > release/SMSforwarder-${{ steps.version.outputs.version_name }}-release-checksums.txt
      - name: Create Release and Upload Assets
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          name: SMSforwarder ${{ github.ref_name }}
          body: |
            ## SMSforwarder ${{ github.ref_name }} - é‡å¤§åŠŸèƒ½æ›´æ–°
            
            ### ğŸ“± Androidåº”ç”¨æ›´æ–°
            
            **ç‰ˆæœ¬**: ${{ steps.version.outputs.version_name }}
            **æ„å»ºæ—¶é—´**: ${{ github.event.head_commit.timestamp }}
            **æ›´æ–°å†…å®¹**: åŒå¡æ”¯æŒã€å…¼å®¹æ€§æ£€æµ‹ã€å¥åº·ç›‘æ§ã€é«˜çº§é…ç½®ç®¡ç†
            
            ### ğŸ“¦ ä¸‹è½½
            
            - **Debugç‰ˆæœ¬**: ç”¨äºæµ‹è¯•å’Œè°ƒè¯•
            - **Releaseç‰ˆæœ¬**: ç”Ÿäº§ç¯å¢ƒä½¿ç”¨(æœªç­¾å)
            
            ### âœ¨ åŠŸèƒ½ç‰¹æ€§
            
            - ğŸš€ è‡ªåŠ¨SMSè½¬å‘åˆ°é‚®ç®±
            - âš™ï¸ æ™ºèƒ½è½¬å‘è§„åˆ™é…ç½®  
            - ğŸ“Š è¯¦ç»†ç»Ÿè®¡ä¿¡æ¯
            - ğŸ“ å®Œæ•´æ—¥å¿—è®°å½•
            - ğŸ¨ ç°ä»£åŒ–Material Designç•Œé¢
            
            ### ğŸ†• v1.0.6 æ–°å¢åŠŸèƒ½
            
            - ğŸ”„ **åŒå¡è®¾å¤‡æ”¯æŒ**: è‡ªåŠ¨è¯†åˆ«SIMå¡æ§½å’Œè¿è¥å•†ä¿¡æ¯
            - ğŸ” **è®¾å¤‡å…¼å®¹æ€§æ£€æµ‹**: æ™ºèƒ½è¯„åˆ†ç³»ç»Ÿ (0-100åˆ†)
            - â¤ï¸ **å®šæœŸå¥åº·æ£€æµ‹**: å¿ƒè·³ç›‘æ§å’Œå¼‚å¸¸å‘Šè­¦
            - âš™ï¸ **é«˜çº§é…ç½®ç®¡ç†**: æ‰¹é‡å¯¼å…¥/å¯¼å‡ºã€æ™ºèƒ½éªŒè¯
            - ğŸ“± **SIMå¡ä¿¡æ¯å±•ç¤º**: å®æ—¶çŠ¶æ€å’Œä¿¡å·å¼ºåº¦
            - ğŸ›¡ï¸ **ç³»ç»Ÿæ·±åº¦æ£€æµ‹**: åå°èƒ½åŠ›å’Œæƒé™åˆ†æ
            
            ### ğŸ”’ å®‰å…¨è¯´æ˜
            
            Releaseç‰ˆæœ¬ä¸ºæœªç­¾åAPKï¼Œå»ºè®®è‡ªè¡Œç­¾ååä½¿ç”¨ã€‚
            
            ### ğŸ“‹ å®‰è£…è¦æ±‚
            
            - Android 8.0+ (API 26+) - è¦†ç›–95%+ç”¨æˆ·
            - SMSæ¥æ”¶å’Œè¯»å–æƒé™
            - ç”µè¯çŠ¶æ€æƒé™ (åŒå¡æ”¯æŒ)
            - ç½‘ç»œå’Œé€šçŸ¥æƒé™
            
          draft: false
          prerelease: false
          files: |
            app/build/outputs/apk/debug/SMSforwarder-${{ steps.version.outputs.version_name }}-debug.apk
            app/build/outputs/apk/release/SMSforwarder-${{ steps.version.outputs.version_name }}-release-unsigned.apk
            app/build/outputs/apk/debug/SMSforwarder-${{ steps.version.outputs.version_name }}-debug-checksums.txt
            app/build/outputs/apk/release/SMSforwarder-${{ steps.version.outputs.version_name }}-release-checksums.txt 